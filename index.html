<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Budget Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js CDN for On-Device OCR -->
    <script src='https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            padding: 1rem; /* p-4 */
        }
        /* Ensure the main card is centered and responsive */
        .main-card {
            width: 100%;
            max-width: 768px; /* max-w-4xl */
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            margin-top: 2rem; /* Add some top margin */
        }
        @media (min-width: 640px) { /* sm:breakpoint */
            .main-card {
                padding: 2rem; /* sm:p-8 */
            }
        }
        @media (min-width: 1024px) { /* lg:breakpoint */
            .main-card {
                padding: 2rem; /* lg:p-8 */
            }
        }

        /* Styles for Circular Progress SVG */
        .circular-progress-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circular-progress-text-container {
            position: absolute;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        .circular-progress-percentage {
            font-size: 1.125rem; /* text-lg */
            font-weight: bold;
            color: #374151; /* gray-800 */
        }
        .circular-progress-spent-text {
            font-size: 0.75rem; /* text-xs */
            color: #6B7280; /* gray-500 */
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
        }
        .custom-modal-content {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
        }
        .custom-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4F46E5;
            margin-bottom: 1rem;
        }
        .custom-modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }
        .custom-modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #ffffff;
            transition: background-color 0.3s;
        }
        .custom-modal-confirm {
            background-color: #DC2626; /* red-600 */
        }
        .custom-modal-confirm:hover {
            background-color: #B91C1C; /* red-700 */
        }
        .custom-modal-cancel {
            background-color: #6B7280; /* gray-500 */
        }
        .custom-modal-cancel:hover {
            background-color: #4B5563; /* gray-600 */
        }
    </style>
</head>
<body>
    <div class="main-card">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-700 mb-6">
            Monthly Budget Tracker
        </h1>

        <!-- User ID Display -->
        <div id="userIdDisplay" class="text-center text-sm text-gray-500 mb-4 hidden">
            User ID: <span id="userIdValue" class="font-mono text-gray-700"></span>
        </div>

        <!-- Notification Area -->
        <div id="notificationArea" class="hidden p-4 mb-6 rounded-lg shadow-md text-center">
            <p id="notificationMessage" class="font-medium"></p>
            <button id="dismissNotification" class="mt-2 text-sm font-semibold underline">
                Dismiss
            </button>
        </div>

        <!-- Income & Overall Summary -->
        <div class="bg-indigo-50 p-4 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-indigo-800 mb-3">Overall Summary</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-lg">
                <p><span class="font-medium">Income:</span> <span id="incomeValue">0.00</span> EGP</p>
                <p><span class="font-medium">Total Allocated:</span> <span id="totalAllocatedValue">0.00</span> EGP</p>
                <p><span class="font-medium">Total Spent:</span> <span id="totalSpentValue">0.00</span> EGP</p>
                <p id="overallRemainingText" class="sm:col-span-3 text-2xl font-bold">
                    Remaining Budget: <span id="overallRemainingValue">0.00</span> EGP
                </p>
            </div>
        </div>

        <!-- Add Spending Section -->
        <div class="bg-blue-50 p-4 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-blue-800 mb-3">Add Spending</h2>
            
            <!-- Manual Spending Input -->
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-blue-700 mb-2">Manually Add Expense</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <select id="selectedCategory" class="flex-grow p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Category</option>
                        <!-- Categories will be populated here by JS -->
                    </select>
                    <input
                        type="number"
                        id="addAmount"
                        placeholder="Amount Spent (EGP)"
                        class="flex-grow p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        min="0"
                        step="0.01"
                    />
                    <button
                        id="addSpendingButton"
                        class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out"
                    >
                        Add Manually
                    </button>
                </div>
            </div>

            <!-- Receipt Upload Section -->
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-blue-700 mb-2">Upload Receipt (On-Device OCR)</h3>
                <input
                    type="file"
                    id="receiptImageInput"
                    accept="image/*"
                    class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100"
                />
                <button
                    id="processReceiptButton"
                    class="mt-4 px-6 py-3 font-semibold rounded-lg shadow-md transition duration-300 ease-in-out"
                >
                    Process Receipt
                </button>
                <p id="processingReceiptMessage" class="mt-2 text-sm text-blue-600 hidden">Processing receipt with Tesseract.js (this may take a moment)...</p>
                <p id="receiptAuthWarning" class="mt-2 text-sm text-red-600 hidden">Please wait for authentication to complete to use receipt upload.</p>
            </div>
        </div>

        <!-- Category Management Section -->
        <div class="bg-purple-50 p-4 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-purple-800 mb-3">Manage Categories</h2>
            <button
                id="addCategoryModalButton"
                class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 ease-in-out"
            >
                Add New Category
            </button>
        </div>

        <!-- Category Details -->
        <div id="categoryDetailsContainer" class="space-y-6">
            <!-- Categories will be dynamically loaded here -->
        </div>
    </div>

    <!-- Category Add/Edit Modal (Hidden by default) -->
    <div id="categoryModalOverlay" class="custom-modal-overlay hidden">
        <div class="custom-modal-content">
            <h2 id="categoryModalTitle" class="custom-modal-title">Add New Category</h2>
            <form id="categoryForm">
                <div class="mb-4">
                    <label for="modalCategoryName" class="block text-gray-700 text-sm font-bold mb-2">
                        Category Name:
                    </label>
                    <input
                        type="text"
                        id="modalCategoryName"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    />
                </div>
                <div class="mb-4">
                    <label for="modalAllocatedAmount" class="block text-gray-700 text-sm font-bold mb-2">
                        Allocated Amount (EGP):
                    </label>
                    <input
                        type="number"
                        id="modalAllocatedAmount"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        min="0"
                        step="0.01"
                        required
                    />
                </div>
                <div class="mb-6">
                    <label for="modalCategoryType" class="block text-gray-700 text-sm font-bold mb-2">
                        Category Type:
                    </label>
                    <select
                        id="modalCategoryType"
                        class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    >
                        <option value="Needs">Needs</option>
                        <option value="Wants">Wants</option>
                        <option value="Savings">Savings</option>
                    </select>
                </div>
                <div class="custom-modal-buttons">
                    <button
                        type="submit"
                        class="custom-modal-button bg-indigo-600 hover:bg-indigo-700"
                    >
                        Add Category
                    </button>
                    <button
                        type="button"
                        id="cancelCategoryModal"
                        class="custom-modal-button bg-gray-400 hover:bg-gray-500"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // --- IMPORTANT: REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIGURATION ---
        // Your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAnDwriW_zqBkZDrdLcDrg82f5_UoJzeUE",
            authDomain: "home-budget-app-c4f05.firebaseapp.com",
            projectId: "home-budget-app-c4f05",
            storageBucket: "home-budget-app-c4f05.firebasestorage.app",
            messagingSenderId: "833811767859",
            appId: "1:833811767859:web:67e93c3863298d41fd7946",
            measurementId: "G-SEENLJLX3V"
        };
        // --- END OF IMPORTANT REPLACEMENTS ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state variables (mimicking React state)
        let currentBudget = {
            income: 27725, // EGP
            categories: [
                { id: 'groceries', name: 'Groceries (2 people + dog)', allocated: 6000, spent: 0, type: 'Needs' },
                { id: 'utilities', name: 'Utilities', allocated: 1500, spent: 0, type: 'Needs' },
                { id: 'homeOwnership', name: 'Home Ownership Costs', allocated: 1675, spent: 0, type: 'Needs' },
                { id: 'fuel', name: 'Fuel for Car', allocated: 2000, spent: 0, type: 'Needs' },
                { id: 'healthcare', name: 'Basic Healthcare & Personal Care', allocated: 700, spent: 0, type: 'Needs' },
                { id: 'dogEssentials', name: 'Dog Essentials', allocated: 1200, spent: 0, type: 'Needs' },
                { id: 'cigarettes', name: 'Cigarettes', allocated: 4500, spent: 0, type: 'Wants' },
                { id: 'gifts', name: 'Gifts (Social Obligations)', allocated: 1000, spent: 0, type: 'Wants' },
                { id: 'sweetTooth', name: 'Sweet Tooth', allocated: 500, spent: 0, type: 'Wants' },
                { id: 'subscriptions', name: 'Subscriptions', allocated: 390, spent: 0, type: 'Wants' },
                { id: 'diningOut', name: 'Take Out/Dining Out', allocated: 1500, spent: 0, type: 'Wants' },
                { id: 'miscWants', name: 'Miscellaneous Wants (incl. Shopping & Entertainment)', allocated: 2260, spent: 0, type: 'Wants' },
                { id: 'savings', name: 'Savings', allocated: 4000, spent: 0, type: 'Savings' },
            ],
        };
        let currentUserId = null;
        let isAuthReady = false;
        let isProcessingReceipt = false;
        // Removed isListening as voice command is gone
        let editingCategory = null; // Stores category object when editing

        // Mapping for AI extracted categories to internal budget IDs (supports English and Arabic)
        const categoryMapping = {
            "groceries": "groceries", "بقالة": "groceries", "مشتريات": "groceries", "سوبر ماركت": "groceries",
            "utilities": "utilities", "فواتير": "utilities", "كهرباء": "كهرباء", "مياه": "مياه", "غاز": "غاز", "انترنت": "انترنت", "bills": "utilities",
            "home ownership costs": "homeOwnership", "صيانة منزل": "homeOwnership", "رسوم مبنى": "homeOwnership", "نظافة شقة": "homeOwnership", "home maintenance": "homeOwnership", "rent": "homeOwnership", "housing": "homeOwnership",
            "fuel for car": "fuel", "وقود": "fuel", "بنزين": "fuel", "gas": "fuel", "petrol": "fuel", "car": "fuel",
            "basic healthcare & personal care": "healthcare", "صحة": "healthcare", "عناية شخصية": "healthcare", "صيدلية": "healthcare", "pharmacy": "healthcare", "doctor": "healthcare", "health": "healthcare", "personal care": "healthcare",
            "dog essentials": "dogEssentials", "مستلزمات كلب": "dogEssentials", "طعام كلاب": "dogEssentials", "بيطري": "dogEssentials", "pet food": "dogEssentials", "vet": "dogEssentials", "dog food": "dogEssentials",
            "cigarettes": "cigarettes", "سجائر": "cigarettes", "دخان": "دخان", "smoking": "cigarettes",
            "gifts": "gifts", "هدايا": "gifts", "مناسبات اجتماعية": "gifts", "presents": "gifts", "social": "gifts",
            "sweet tooth": "sweetTooth", "حلويات": "حلويات", "سكريات": "سكريات", "dessert": "sweetTooth", "sweets": "sweetTooth", "chocolate": "sweetTooth",
            "subscriptions": "subscriptions", "اشتراكات": "اشتراكات", "نتفليكس": "subscriptions", "جوجل ون": "subscriptions", "سبوتيفاي": "subscriptions", "netflix": "subscriptions", "spotify": "subscriptions", "google one": "subscriptions", "apps": "subscriptions",
            "take out/dining out": "diningOut", "مطاعم": "مطاعم", "وجبات سريعة": "وجبات سريعة", "خارج المنزل": "خارج المنزل", "restaurant": "diningOut", "food delivery": "diningOut", "eating out": "diningOut",
            "miscellaneous wants": "miscWants", "متفرقات": "متفرقات", "تسوق": "تسوق", "ترفيه": "ترفيه", "أخرى": "أخرى", "shopping": "miscWants", "entertainment": "miscWants", "other": "miscWants",
            "savings": "savings", "ادخار": "savings", "توفير": "savings", "save": "savings"
        };


        // --- Utility Functions ---

        function showNotification(message, type) {
            const notificationArea = document.getElementById('notificationArea');
            const notificationMessage = document.getElementById('notificationMessage');
            
            // Clear previous classes
            notificationArea.className = 'p-4 mb-6 rounded-lg shadow-md text-center';

            notificationMessage.textContent = message;
            switch (type) {
                case 'warning':
                    notificationArea.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'danger':
                    notificationArea.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                    notificationArea.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'success':
                    notificationArea.classList.add('bg-green-100', 'text-green-800');
                    break;
            }
            notificationArea.classList.remove('hidden');
        }

        function clearNotification() {
            document.getElementById('notificationArea').classList.add('hidden');
            document.getElementById('notificationMessage').textContent = '';
        }

        function getOverallRemainingColor(remaining) {
            const totalIncomeAllocated = currentBudget.categories.filter(cat => cat.type !== 'Savings').reduce((sum, cat) => sum + cat.allocated, 0);
            if (remaining < 0) {
                return 'text-red-600';
            } else if (totalIncomeAllocated > 0 && remaining <= 0.2 * totalIncomeAllocated) {
                return 'text-yellow-600';
            }
            return 'text-green-600';
        }

        // --- UI Rendering Functions ---

        function renderSummary() {
            const totalAllocated = currentBudget.categories.reduce((sum, cat) => sum + cat.allocated, 0);
            const totalSpent = currentBudget.categories.reduce((sum, cat) => sum + cat.spent, 0);
            const overallRemaining = currentBudget.income - totalSpent;

            document.getElementById('incomeValue').textContent = currentBudget.income.toFixed(2);
            document.getElementById('totalAllocatedValue').textContent = totalAllocated.toFixed(2);
            document.getElementById('totalSpentValue').textContent = totalSpent.toFixed(2);
            document.getElementById('overallRemainingValue').textContent = overallRemaining.toFixed(2);
            
            const overallRemainingTextElement = document.getElementById('overallRemainingText');
            overallRemainingTextElement.className = `sm:col-span-3 text-2xl font-bold ${getOverallRemainingColor(overallRemaining)}`;
        }

        function renderCategories() {
            const categoryDetailsContainer = document.getElementById('categoryDetailsContainer');
            categoryDetailsContainer.innerHTML = ''; // Clear existing categories

            const types = ['Needs', 'Wants', 'Savings'];
            types.forEach(type => {
                const typeSection = document.createElement('div');
                typeSection.className = 'bg-gray-50 p-4 rounded-lg shadow-inner';
                typeSection.innerHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mb-4">${type}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoryGrid-${type}">
                        <!-- Category cards will go here -->
                    </div>
                `;
                categoryDetailsContainer.appendChild(typeSection);

                const categoryGrid = typeSection.querySelector(`#categoryGrid-${type}`);
                currentBudget.categories.filter(cat => cat.type === type).forEach(category => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200 flex flex-col items-center text-center';
                    
                    const percentage = category.allocated > 0 ? Math.min(100, (category.spent / category.allocated) * 100) : 0;
                    const radius = (100 - 8) / 2; // size - strokeWidth
                    const circumference = radius * 2 * Math.PI;
                    const offset = circumference - (percentage / 100) * circumference;
                    let strokeColor = '#22C55E'; // green-500
                    if (percentage >= 100) {
                        strokeColor = '#EF4444'; // red-500
                    } else if (percentage >= 80) {
                        strokeColor = '#EAB308'; // yellow-500
                    }

                    categoryCard.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${category.name}</h3>
                        <div class="circular-progress-container" style="width: 100px; height: 100px;">
                            <svg class="transform -rotate-90" width="100" height="100">
                                <circle
                                    class="text-gray-300"
                                    stroke="currentColor"
                                    stroke-width="8"
                                    fill="transparent"
                                    r="${radius}"
                                    cx="50"
                                    cy="50"
                                />
                                <circle
                                    class="transition-all duration-500 ease-in-out"
                                    stroke="${strokeColor}"
                                    stroke-width="8"
                                    fill="transparent"
                                    r="${radius}"
                                    cx="50"
                                    cy="50"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${offset}"
                                    stroke-linecap="round"
                                />
                            </svg>
                            <div class="circular-progress-text-container">
                                <span class="circular-progress-percentage">${percentage.toFixed(0)}%</span>
                                <p class="circular-progress-spent-text">Spent</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm w-full">
                            <p class="text-gray-600">Allocated: ${category.allocated.toFixed(2)} EGP</p>
                            <p class="text-gray-600">Spent: ${category.spent.toFixed(2)} EGP</p>
                            <p class="font-medium mt-1 ${getOverallRemainingColor(category.allocated - category.spent)}">
                                Remaining: ${(category.allocated - category.spent).toFixed(2)} EGP
                            </p>
                            <div class="flex justify-center gap-2 mt-3">
                                <button data-id="${category.id}" class="edit-category-btn p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition duration-200" title="Edit Category">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                </button>
                                <button data-id="${category.id}" class="delete-category-btn p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition duration-200" title="Delete Category">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    categoryGrid.appendChild(categoryCard);
                });
            });

            // Re-populate category select dropdown for manual spending
            const selectCategoryDropdown = document.getElementById('selectedCategory');
            selectCategoryDropdown.innerHTML = '<option value="">Select Category</option>';
            currentBudget.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.type})`;
                selectCategoryDropdown.appendChild(option);
            });

            // Add event listeners for edit/delete buttons
            document.querySelectorAll('.edit-category-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const categoryId = event.currentTarget.dataset.id;
                    const categoryToEdit = currentBudget.categories.find(cat => cat.id === categoryId);
                    openCategoryModal(categoryToEdit);
                });
            });
            document.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const categoryId = event.currentTarget.dataset.id;
                    handleDeleteCategory(categoryId);
                });
            });
        }

        function updateUI() {
            renderSummary();
            renderCategories();
            // Update UI element states based on global variables
            const processReceiptButton = document.getElementById('processReceiptButton');
            // Removed startVoiceInputButton
            const receiptAuthWarning = document.getElementById('receiptAuthWarning');
            // Removed voiceAuthWarning and voiceApiKeyWarning
            const userIdDisplay = document.getElementById('userIdDisplay');
            const userIdValue = document.getElementById('userIdValue');

            if (currentUserId) {
                userIdDisplay.classList.remove('hidden');
                userIdValue.textContent = currentUserId;
            } else {
                userIdDisplay.classList.add('hidden');
            }

            // Tesseract.js does not need API key or auth check for its core function
            processReceiptButton.disabled = isProcessingReceipt || !currentUserId; // Still check auth for saving to Firestore
            processReceiptButton.classList.toggle('bg-gray-400', processReceiptButton.disabled);
            processReceiptButton.classList.toggle('text-gray-700', processReceiptButton.disabled);
            processReceiptButton.classList.toggle('cursor-not-allowed', processReceiptButton.disabled);
            processReceiptButton.classList.toggle('bg-green-600', !processReceiptButton.disabled);
            processReceiptButton.classList.toggle('text-white', !processReceiptButton.disabled);
            processReceiptButton.classList.toggle('hover:bg-green-700', !processReceiptButton.disabled);

            // Removed voice command button state updates

            document.getElementById('processingReceiptMessage').classList.toggle('hidden', !isProcessingReceipt);

            receiptAuthWarning.classList.toggle('hidden', currentUserId !== null);
        }


        // --- Firebase Interaction Functions ---

        async function updateBudgetInFirestore() {
            if (!currentUserId) {
                showNotification('User not authenticated. Data not saved.', 'warning');
                return;
            }
            const userBudgetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUserId}/budget/current`);
            try {
                await setDoc(userBudgetDocRef, currentBudget);
                // Notification handled by snapshot listener
            } catch (error) {
                console.error("Error saving budget to Firestore:", error);
                showNotification(`Error saving data: ${error.message}`, 'danger');
            }
        }

        // --- Core Logic Functions ---

        function updateCategorySpent(categoryId, amount) {
            const updatedCategories = currentBudget.categories.map(cat =>
                cat.id === categoryId
                    ? { ...cat, spent: cat.spent + amount }
                    : cat
            );
            currentBudget = { ...currentBudget, categories: updatedCategories };
            updateBudgetInFirestore(); // Save to Firestore
            showNotification('Spending added successfully!', 'success');
            document.getElementById('addAmount').value = '';
            document.getElementById('selectedCategory').value = '';
        }

        async function processReceipt(file) {
            if (!file) {
                showNotification('Please upload a receipt image first.', 'warning');
                return;
            }
            if (!currentUserId) { // Only check auth for saving data, Tesseract itself is client-side
                showNotification('User not authenticated. Cannot process receipt and save data.', 'warning');
                return;
            }

            isProcessingReceipt = true;
            updateUI(); // Update button state
            showNotification('Processing receipt with Tesseract.js...', 'info');

            try {
                // Use Tesseract.js to recognize text from the image
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'eng+ara', // Language code: English and Arabic
                    { logger: m => console.log(m) } // Optional: log progress to console
                );

                console.log("Tesseract.js Raw Text Output:", text);

                // --- Basic Client-Side Parsing Logic ---
                let extractedAmount = 0;
                let extractedCategory = "Miscellaneous Wants"; // Default if unable to parse

                // Regex to find potential currency amounts (e.g., 123.45, 123)
                // Looks for numbers, optionally with commas or dots, and up to two decimal places
                const amountRegex = /(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{1,2})?|\d+[.,]\d{1,2})/;
                const amounts = text.match(new RegExp(amountRegex.source, 'g')); // Find all matches

                if (amounts && amounts.length > 0) {
                    // Try to find the largest number as a potential total
                    let maxAmount = 0;
                    amounts.forEach(amtStr => {
                        // Clean string for parsing (remove commas, ensure dot for decimals)
                        let cleanedAmt = amtStr.replace(/,/g, ''); // Remove commas
                        if (cleanedAmt.includes('.')) {
                            // If it has a dot, assume it's already decimal-ready
                        } else if (cleanedAmt.includes('٫')) { // Handle Arabic decimal separator
                            cleanedAmt = cleanedAmt.replace('٫', '.');
                        } else if (cleanedAmt.length > 2 && !cleanedAmt.includes('.')) {
                            // Simple heuristic: if a large number has no decimal, assume it's an integer
                            // For true currency parsing, more context is needed.
                        }
                        const num = parseFloat(cleanedAmt);
                        if (!isNaN(num) && num > maxAmount) {
                            maxAmount = num;
                        }
                    });
                    extractedAmount = maxAmount;
                }

                // Simple keyword matching for categories
                const lowerCaseText = text.toLowerCase();
                const keywords = {
                    "groceries": ["groceries", "بقالة", "مشتريات", "سوبر ماركت", "supermarket", "food", "اكل", "طعام"],
                    "utilities": ["utilities", "فواتير", "كهرباء", "مياه", "غاز", "انترنت", "bills", "electricity", "water", "gas", "internet"],
                    "homeOwnership": ["home ownership", "صيانة منزل", "رسوم مبنى", "نظافة شقة", "home maintenance", "rent", "housing", "ايجار", "صيانة"],
                    "fuel": ["fuel", "وقود", "بنزين", "gas", "petrol", "car", "سيارة", "محروقات"],
                    "healthcare": ["healthcare", "صحة", "عناية شخصية", "صيدلية", "pharmacy", "doctor", "health", "personal care", "دكتور", "علاج"],
                    "dogEssentials": ["dog essentials", "مستلزمات كلب", "طعام كلاب", "بيطري", "pet food", "vet", "dog food", "حيوانات"],
                    "cigarettes": ["cigarettes", "سجائر", "دخان", "smoking"],
                    "gifts": ["gifts", "هدايا", "مناسبات اجتماعية", "presents", "social", "هدية"],
                    "sweetTooth": ["sweet tooth", "حلويات", "سكريات", "dessert", "sweets", "chocolate", "شوكولاتة"],
                    "subscriptions": ["subscriptions", "اشتراكات", "نتفليكس", "جوجل ون", "سبوتيفاي", "netflix", "spotify", "google one", "apps", "تطبيقات"],
                    "diningOut": ["take out", "dining out", "مطاعم", "وجبات سريعة", "خارج المنزل", "restaurant", "food delivery", "eating out", "مطعم", "وجبات"],
                    "miscWants": ["miscellaneous wants", "متفرقات", "تسوق", "ترفيه", "أخرى", "shopping", "entertainment", "other", "شراء", "ترفيه"]
                };

                for (const categoryId in keywords) {
                    const categoryKeywords = keywords[categoryId];
                    for (const keyword of categoryKeywords) {
                        if (lowerCaseText.includes(keyword.toLowerCase())) {
                            extractedCategory = categoryId;
                            break; // Found a match, take the first one
                        }
                    }
                    if (extractedCategory !== "Miscellaneous Wants") {
                        break; // Found a category, stop searching
                    }
                }
                
                // Apply the extracted data
                if (!isNaN(extractedAmount) && extractedAmount > 0) {
                    updateCategorySpent(extractedCategory, extractedAmount);
                    showNotification(`Receipt processed (Tesseract.js)! Added ${extractedAmount.toFixed(2)} EGP to ${currentBudget.categories.find(cat => cat.id === extractedCategory)?.name}.`, 'success');
                } else {
                    showNotification(`Could not accurately parse receipt (Tesseract.js). Please add manually. Raw Text: "${text.substring(0, Math.min(text.length, 100))}..."`, 'warning');
                }

            } catch (error) {
                console.error("Error processing receipt with Tesseract.js:", error);
                showNotification(`Error processing receipt with Tesseract.js: ${error.message}. Please try again.`, 'danger');
            } finally {
                isProcessingReceipt = false;
                document.getElementById('receiptImageInput').value = ''; // Clear file input
                updateUI(); // Update button state
            }
        }

        // Removed startVoiceInput and processVoiceCommand functions

        // --- Category Management Functions ---

        function handleSaveCategory(newCategoryData) {
            if (!currentUserId) {
                showNotification('User not authenticated. Cannot save category.', 'warning');
                return;
            }

            let updatedCategories;
            if (editingCategory) {
                // Edit existing category
                updatedCategories = currentBudget.categories.map(cat =>
                    cat.id === newCategoryData.id ? newCategoryData : cat
                );
            } else {
                // Add new category
                updatedCategories = [...currentBudget.categories, newCategoryData];
            }
            currentBudget = { ...currentBudget, categories: updatedCategories };
            updateBudgetInFirestore();
            showNotification('Category saved successfully!', 'success');
            closeCategoryModal();
        }

        function handleDeleteCategory(categoryId) {
            if (!currentUserId) {
                showNotification('User not authenticated. Cannot delete category.', 'warning');
                return;
            }

            const confirmModal = document.createElement('div');
            confirmModal.className = 'custom-modal-overlay';
            confirmModal.innerHTML = `
                <div class="custom-modal-content">
                    <h2 class="custom-modal-title">Confirm Deletion</h2>
                    <p class="text-gray-700 mb-6">Are you sure you want to delete this category? This action cannot be undone.</p>
                    <div class="custom-modal-buttons">
                        <button id="confirmDeleteBtn" class="custom-modal-button custom-modal-confirm">Delete</button>
                        <button id="cancelDeleteBtn" class="custom-modal-button custom-modal-cancel">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                const updatedCategories = currentBudget.categories.filter(cat => cat.id !== categoryId);
                currentBudget = { ...currentBudget, categories: updatedCategories };
                updateBudgetInFirestore();
                showNotification('Category deleted successfully!', 'success');
                confirmModal.remove();
            });

            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                confirmModal.remove();
            });
        }

        function openCategoryModal(category = null) {
            editingCategory = category;
            const modalOverlay = document.getElementById('categoryModalOverlay');
            const modalTitle = document.getElementById('categoryModalTitle');
            const modalCategoryName = document.getElementById('modalCategoryName');
            const modalAllocatedAmount = document.getElementById('modalAllocatedAmount');
            const modalCategoryType = document.getElementById('modalCategoryType');
            const formSubmitButton = modalOverlay.querySelector('button[type="submit"]');

            if (category) {
                modalTitle.textContent = 'Edit Category';
                modalCategoryName.value = category.name;
                modalAllocatedAmount.value = category.allocated;
                modalCategoryType.value = category.type;
                formSubmitButton.textContent = 'Save Changes';
            } else {
                modalTitle.textContent = 'Add New Category';
                modalCategoryName.value = '';
                modalAllocatedAmount.value = '';
                modalCategoryType.value = 'Needs';
                formSubmitButton.textContent = 'Add Category';
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModalOverlay').classList.add('hidden');
            editingCategory = null;
        }


        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial UI update for loading state
            updateUI(); 

            // Firebase Auth Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isAuthReady = true;
                    showNotification('Authenticated successfully!', 'success');
                    // Start Firestore listener after auth is ready
                    const userBudgetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUserId}/budget/current`);
                    onSnapshot(userBudgetDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentBudget = docSnap.data();
                            showNotification('Budget loaded from cloud!', 'success');
                        } else {
                            // If no budget exists, create a default one
                            setDoc(userBudgetDocRef, currentBudget)
                                .then(() => showNotification('Default budget created in cloud!', 'success'))
                                .catch(error => showNotification(`Error creating default budget: ${error.message}`, 'danger'));
                        }
                        updateUI(); // Update UI after data load/change
                    }, (error) => {
                        console.error("Error fetching budget:", error);
                        showNotification(`Error syncing budget: ${error.message}`, 'danger');
                    });
                } else {
                    currentUserId = null;
                    isAuthReady = true; // Still ready, but user is not logged in
                    showNotification('Not authenticated. Data will not be saved persistently.', 'warning');
                    updateUI(); // Update UI even if not authenticated
                }
            });

            // Initial anonymous sign-in
            signInAnonymously(auth).catch(error => {
                console.error("Firebase Anonymous Auth error:", error);
                showNotification(`Authentication failed: ${error.message}`, 'danger');
            });


            // Event Listeners
            document.getElementById('dismissNotification').addEventListener('click', clearNotification);
            document.getElementById('addSpendingButton').addEventListener('click', () => {
                const selectedCategoryId = document.getElementById('selectedCategory').value;
                const amount = parseFloat(document.getElementById('addAmount').value);
                if (selectedCategoryId && !isNaN(amount) && amount > 0) {
                    updateCategorySpent(selectedCategoryId, amount);
                } else {
                    showNotification('Please select a category and enter a valid amount.', 'warning');
                }
            });

            document.getElementById('receiptImageInput').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    processReceipt(file);
                } else {
                    showNotification('No file selected.', 'warning');
                }
            });

            document.getElementById('processReceiptButton').addEventListener('click', () => {
                const fileInput = document.getElementById('receiptImageInput');
                if (fileInput.files.length > 0) {
                    processReceipt(fileInput.files[0]);
                } else {
                    showNotification('Please select an image first using the "Choose File" button.', 'warning');
                }
            });

            // Removed voice command button event listener
            
            document.getElementById('addCategoryModalButton').addEventListener('click', () => openCategoryModal());
            document.getElementById('cancelCategoryModal').addEventListener('click', closeCategoryModal);
            document.getElementById('categoryForm').addEventListener('submit', (event) => {
                event.preventDefault();
                const name = document.getElementById('modalCategoryName').value;
                const allocated = parseFloat(document.getElementById('modalAllocatedAmount').value);
                const type = document.getElementById('modalCategoryType').value;

                if (name && !isNaN(allocated) && allocated >= 0) {
                    const newCategoryData = {
                        id: editingCategory ? editingCategory.id : Date.now().toString(),
                        name: name,
                        allocated: allocated,
                        spent: editingCategory ? editingCategory.spent : 0,
                        type: type
                    };
                    handleSaveCategory(newCategoryData);
                } else {
                    showNotification('Please fill all category fields correctly.', 'warning');
                }
            });
        });
    </script>
</body>
</html>
