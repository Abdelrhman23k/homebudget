<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Budget Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js CDN for On-Device OCR -->
    <script src='https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            padding: 1rem; /* p-4 */
        }
        /* Ensure the main card is centered and responsive */
        .main-card {
            width: 100%;
            max-width: 768px; /* max-w-4xl */
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            margin-top: 2rem; /* Add some top margin */
        }
        @media (min-width: 640px) { /* sm:breakpoint */
            .main-card {
                padding: 2rem; /* sm:p-8 */
            }
        }
        @media (min-width: 1024px) { /* lg:breakpoint */
            .main-card {
                padding: 2rem; /* lg:p-8 */
            }
        }

        /* Styles for Circular Progress SVG */
        .circular-progress-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circular-progress-text-container {
            position: absolute;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        .circular-progress-percentage {
            font-size: 1.125rem; /* text-lg */
            font-weight: bold;
            color: #374151; /* gray-800 */
        }
        .circular-progress-spent-text {
            font-size: 0.75rem; /* text-xs */
            color: #6B7280; /* gray-500 */
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000;
        }
        .custom-modal-content {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
        }
        .custom-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4F46E5;
            margin-bottom: 1rem;
        }
        .custom-modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }
        .custom-modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #ffffff;
            transition: background-color 0.3s;
        }
        .custom-modal-confirm {
            background-color: #DC2626; /* red-600 */
        }
        .custom-modal-confirm:hover {
            background-color: #B91C1C; /* red-700 */
        }
        .custom-modal-cancel {
            background-color: #6B7280; /* gray-500 */
        }
        .custom-modal-cancel:hover {
            background-color: #4B5563; /* gray-600 */
        }
    </style>
</head>
<body>
    <div class="main-card">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-700 mb-6">
            Monthly Budget Tracker
        </h1>

        <!-- User ID Display -->
        <div id="userIdDisplay" class="text-center text-sm text-gray-500 mb-4 hidden">
            User ID: <span id="userIdValue" class="font-mono text-gray-700"></span>
        </div>

        <!-- Notification Area -->
        <div id="notificationArea" class="hidden p-4 mb-6 rounded-lg shadow-md text-center">
            <p id="notificationMessage" class="font-medium"></p>
            <button id="dismissNotification" class="mt-2 text-sm font-semibold underline">
                Dismiss
            </button>
        </div>

        <!-- Income & Overall Summary -->
        <div class="bg-indigo-50 p-4 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-indigo-800 mb-3">Overall Summary</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-lg">
                <p><span class="font-medium">Income:</span> <span id="incomeValue">0.00</span> EGP</p>
                <p><span class="font-medium">Total Allocated:</span> <span id="totalAllocatedValue">0.00</span> EGP</p>
                <p><span class="font-medium">Total Spent:</span> <span id="totalSpentValue">0.00</span> EGP</p>
                <p id="overallRemainingText" class="sm:col-span-3 text-2xl font-bold">
                    Remaining Budget: <span id="overallRemainingValue">0.00</span> EGP
                </p>
            </div>
        </div>

        <!-- Add Spending Section -->
        <div class="bg-blue-50 p-4 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-blue-800 mb-3">Add Spending</h2>
            
            <!-- Manual Spending Input (Now opens a modal) -->
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-blue-700 mb-2">Manually Add Expense</h3>
                <button
                    id="openAddTransactionModalButton"
                    class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out"
                >
                    Add New Expense
                </button>
            </div>

            <!-- Receipt Upload Section -->
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-blue-700 mb-2">Upload Receipt (On-Device OCR)</h3>
                <input
                    type="file"
                    id="receiptImageInput"
                    accept="image/*"
                    class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100"
                />
                <button
                    id="processReceiptButton"
                    class="mt-4 px-6 py-3 font-semibold rounded-lg shadow-md transition duration-300 ease-in-out"
                >
                    Process Receipt
                </button>
                <p id="processingReceiptMessage" class="mt-2 text-sm text-blue-600 hidden">Processing receipt with Tesseract.js (this may take a moment)...</p>
                <p id="receiptAuthWarning" class="mt-2 text-sm text-red-600 hidden">Please wait for authentication to complete to use receipt upload.</p>
            </div>
        </div>

        <!-- Category Management Section -->
        <div class="bg-purple-50 p-4 rounded-lg shadow-inner mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-purple-800 mb-3">Manage Categories</h2>
            <button
                id="addCategoryModalButton"
                class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 ease-in-out"
            >
                Add New Category
            </button>
        </div>

        <!-- Category Details -->
        <div id="categoryDetailsContainer" class="space-y-6">
            <!-- Categories will be dynamically loaded here -->
        </div>

        <!-- Transaction History Section -->
        <div class="bg-green-50 p-4 rounded-lg shadow-inner mt-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-green-800 mb-3">Transaction History</h2>
            <div id="transactionList" class="space-y-3">
                <!-- Transactions will be dynamically loaded here -->
                <p class="text-gray-500" id="noTransactionsMessage">No transactions recorded yet.</p>
            </div>
        </div>
    </div>

    <!-- Category Add/Edit Modal (Hidden by default) -->
    <div id="categoryModalOverlay" class="custom-modal-overlay hidden">
        <div class="custom-modal-content">
            <h2 id="categoryModalTitle" class="custom-modal-title">Add New Category</h2>
            <form id="categoryForm">
                <div class="mb-4">
                    <label for="modalCategoryName" class="block text-gray-700 text-sm font-bold mb-2">
                        Category Name:
                    </label>
                    <input
                        type="text"
                        id="modalCategoryName"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    />
                </div>
                <div class="mb-4">
                    <label for="modalAllocatedAmount" class="block text-gray-700 text-sm font-bold mb-2">
                        Allocated Amount (EGP):
                    </label>
                    <input
                        type="number"
                        id="modalAllocatedAmount"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        min="0"
                        step="0.01"
                        required
                    />
                </div>
                <div class="mb-6">
                    <label for="modalCategoryType" class="block text-gray-700 text-sm font-bold mb-2">
                        Category Type:
                    </label>
                    <select
                        id="modalCategoryType"
                        class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    >
                        <option value="Needs">Needs</option>
                        <option value="Wants">Wants</option>
                        <option value="Savings">Savings</option>
                    </select>
                </div>
                <div class="custom-modal-buttons">
                    <button
                        type="submit"
                        class="custom-modal-button bg-indigo-600 hover:bg-indigo-700"
                    >
                        Add Category
                    </button>
                    <button
                        type="button"
                        id="cancelCategoryModal"
                        class="custom-modal-button bg-gray-400 hover:bg-gray-500"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Add/Edit Modal (Hidden by default) -->
    <div id="transactionModalOverlay" class="custom-modal-overlay hidden">
        <div class="custom-modal-content">
            <h2 id="transactionModalTitle" class="custom-modal-title">Add New Expense</h2>
            <form id="transactionForm">
                <div class="mb-4">
                    <label for="modalTransactionAmount" class="block text-gray-700 text-sm font-bold mb-2">
                        Amount (EGP):
                    </label>
                    <input
                        type="number"
                        id="modalTransactionAmount"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        min="0"
                        step="0.01"
                        required
                    />
                </div>
                <div class="mb-4">
                    <label for="modalTransactionCategory" class="block text-gray-700 text-sm font-bold mb-2">
                        Category:
                    </label>
                    <select
                        id="modalTransactionCategory"
                        class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    >
                        <option value="">Select Category</option>
                        <!-- Categories will be populated by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="modalTransactionDescription" class="block text-gray-700 text-sm font-bold mb-2">
                        Description (Optional):
                    </label>
                    <input
                        type="text"
                        id="modalTransactionDescription"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    />
                </div>
                <div class="mb-6">
                    <label for="modalTransactionDate" class="block text-gray-700 text-sm font-bold mb-2">
                        Date:
                    </label>
                    <input
                        type="date"
                        id="modalTransactionDate"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    />
                </div>
                <div class="custom-modal-buttons">
                    <button
                        type="submit"
                        id="submitTransactionButton"
                        class="custom-modal-button bg-indigo-600 hover:bg-indigo-700"
                    >
                        Add Expense
                    </button>
                    <button
                        type="button"
                        id="cancelTransactionModal"
                        class="custom-modal-button bg-gray-400 hover:bg-gray-500"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // --- IMPORTANT: REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIGURATION ---
        // Your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAnDwriW_zqBkZDrdLcDrg82f5_UoJzeUE",
            authDomain: "home-budget-app-c4f05.firebaseapp.com",
            projectId: "home-budget-app-c4f05",
            storageBucket: "home-budget-app-c4f05.firebasestorage.app",
            messagingSenderId: "833811767859",
            appId: "1:833811767859:web:67e93c3863298d41fd7946",
            measurementId: "G-SEENLJLX3V"
        };
        // --- END OF IMPORTANT REPLACEMENTS ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state variables (mimicking React state)
        let currentBudget = {
            income: 27725, // EGP
            categories: [
                { id: 'groceries', name: 'Groceries (2 people + dog)', allocated: 6000, spent: 0, type: 'Needs' },
                { id: 'utilities', name: 'Utilities', allocated: 1500, spent: 0, type: 'Needs' },
                { id: 'homeOwnership', name: 'Home Ownership Costs', allocated: 1675, spent: 0, type: 'Needs' },
                { id: 'fuel', name: 'Fuel for Car', allocated: 2000, spent: 0, type: 'Needs' },
                { id: 'healthcare', name: 'Basic Healthcare & Personal Care', allocated: 700, spent: 0, type: 'Needs' },
                { id: 'dogEssentials', name: 'Dog Essentials', allocated: 1200, spent: 0, type: 'Needs' },
                { id: 'cigarettes', name: 'Cigarettes', allocated: 4500, spent: 0, type: 'Wants' },
                { id: 'gifts', name: 'Gifts (Social Obligations)', allocated: 1000, spent: 0, type: 'Wants' },
                { id: 'sweetTooth', name: 'Sweet Tooth', allocated: 500, spent: 0, type: 'Wants' },
                { id: 'subscriptions', name: 'Subscriptions', allocated: 390, spent: 0, type: 'Wants' },
                { id: 'diningOut', name: 'Take Out/Dining Out', allocated: 1500, spent: 0, type: 'Wants' },
                { id: 'miscWants', name: 'Miscellaneous Wants (incl. Shopping & Entertainment)', allocated: 2260, spent: 0, type: 'Wants' },
                { id: 'savings', name: 'Savings', allocated: 4000, spent: 0, type: 'Savings' },
            ],
            transactions: [] // New array to store transaction history
        };
        let currentUserId = null;
        let isAuthReady = false;
        let isProcessingReceipt = false;
        let editingCategory = null; // Stores category object when editing
        let editingTransaction = null; // Stores transaction object when editing

        // Mapping for AI extracted categories to internal budget IDs (supports English and Arabic)
        const categoryMapping = {
            "groceries": "groceries", "بقالة": "بقالة", "مشتريات": "مشتريات", "سوبر ماركت": "سوبر ماركت", "supermarket": "groceries", "food": "groceries", "اكل": "groceries", "طعام": "groceries", "carrefour": "groceries", "spinneys": "groceries", "metro market": "groceries", "أسواق": "groceries", "خضروات": "groceries", "فواكه": "groceries", "بضائع": "groceries", "لحوم": "groceries", "دواجن": "groceries", "ألبان": "groceries", "خبز": "groceries", "بقالة": "groceries",
            "utilities": "utilities", "فواتير": "فواتير", "كهرباء": "كهرباء", "مياه": "مياه", "غاز": "غاز", "انترنت": "انترنت", "bills": "utilities", "electricity": "utilities", "water": "utilities", "gas": "utilities", "internet": "utilities", "فاتورة": "utilities", "اتصالات": "utilities",
            "homeOwnership": "homeOwnership", "صيانة منزل": "صيانة منزل", "رسوم مبنى": "رسوم مبنى", "نظافة شقة": "نظافة شقة", "home maintenance": "homeOwnership", "rent": "homeOwnership", "housing": "homeOwnership", "ايجار": "homeOwnership", "صيانة": "homeOwnership", "منزل": "homeOwnership", "عقارات": "homeOwnership",
            "fuel": "fuel", "وقود": "وقود", "بنزين": "بنزين", "gas": "fuel", "petrol": "fuel", "car": "fuel", "سيارة": "fuel", "محروقات": "fuel", "بنزينه": "fuel",
            "healthcare": "healthcare", "صحة": "صحة", "عناية شخصية": "عناية شخصية", "صيدلية": "صيدلية", "pharmacy": "healthcare", "doctor": "healthcare", "health": "healthcare", "personal care": "healthcare", "دكتور": "healthcare", "علاج": "healthcare", "ادوية": "healthcare",
            "dogEssentials": "dogEssentials", "مستلزمات كلب": "مستلزمات كلب", "طعام كلاب": "طعام كلاب", "بيطري": "بيطري", "pet food": "dogEssentials", "vet": "dogEssentials", "dog food": "dogEssentials", "حيوانات": "dogEssentials", "كلاب": "dogEssentials", "قطط": "dogEssentials",
            "cigarettes": "cigarettes", "سجائر": "سجائر", "دخان": "دخان", "smoking": "cigarettes",
            "gifts": "gifts", "هدايا": "هدايا", "مناسبات اجتماعية": "مناسبات اجتماعية", "presents": "gifts", "social": "gifts", "هدية": "gifts",
            "sweetTooth": "sweetTooth", "حلويات": "حلويات", "سكريات": "سكريات", "dessert": "sweetTooth", "sweets": "sweetTooth", "chocolate": "sweetTooth", "كيك": "sweetTooth", "جاتوه": "sweetTooth",
            "subscriptions": "subscriptions", "اشتراكات": "اشتراكات", "نتفليكس": "نتفليكس", "جوجل ون": "جوجل ون", "سبوتيفاي": "سبوتيفاي", "netflix": "subscriptions", "spotify": "subscriptions", "google one": "subscriptions", "apps": "subscriptions", "تطبيقات": "subscriptions", "اشتراك": "subscriptions",
            "diningOut": "diningOut", "take out": "diningOut", "dining out": "diningOut", "مطاعم": "مطاعم", "وجبات سريعة": "وجبات سريعة", "خارج المنزل": "خارج المنزل", "restaurant": "diningOut", "food delivery": "diningOut", "eating out": "diningOut", "مطعم": "diningOut", "وجبات": "diningOut", "كافيه": "diningOut", "قهوة": "diningOut",
            "miscWants": "miscWants", "متفرقات": "متفرقات", "تسوق": "تسوق", "ترفيه": "ترفيه", "أخرى": "أخرى", "shopping": "miscWants", "entertainment": "miscWants", "other": "miscWants", "شراء": "miscWants", "ترفيه": "miscWants", "ملابس": "miscWants", "احذية": "miscWants", "الكترونيات": "miscWants", "decathlon": "miscWants", "ديكاتلون": "miscWants", "رياضة": "miscWants", "sports": "miscWants", "hyper one": "miscWants", "هايبر وان": "miscWants", "butcher": "miscWants", "جزار": "miscWants", "مخبز": "miscWants", "مكتبة": "miscWants", "ألعاب": "miscWants", "هوايات": "miscWants", "أدوات": "miscWants", "منزلية": "miscWants", "مفروشات": "miscWants", "أجهزة": "miscWants", "كهربائية": "miscWants", "ديكور": "miscWants", "أثاث": "miscWants", "مستحضرات تجميل": "miscWants", "عطور": "miscWants", "إكسسوارات": "miscWants", "مجوهات": "miscWants", "ساعات": "miscWants", "حقائب": "miscWants", "أمتعة": "miscWants", "كتب": "miscWants", "مجلات": "miscWants", "جرائد": "miscWants", "قرطاسية": "miscWants", "لوازم مكتبية": "miscWants", "أدوات مدرسية": "miscWants", "أدوات فنية": "miscWants", "آلات موسيقية": "miscWants", "أدوات رياضية": "miscWants", "معدات رياضية": "miscWants", "أدوات تخييم": "miscWants", "أدوات صيد": "miscWants", "أدوات غطس": "miscWants", "أدوات سباحة": "miscWants", "أدوات لياقة": "miscWants", "أدوات بناء": "miscWants", "أدوات حدائق": "miscWants", "أدوات سيارات": "miscWants", "قطع غيار": "miscWants", "إطارات": "miscWants", "بطاريات": "miscWants", "زيوت": "miscWants", "فلاتر": "miscWants", "إصلاحات": "miscWants", "صيانة": "miscWants", "خدمات": "miscWants", "تأمين": "miscWants", "رسوم": "miscWants", "ضرائب": "miscWants", "غرامات": "miscWants", "تبرعات": "miscWants", "مساعدات": "miscWants", "تعليم": "miscWants", "دورات": "miscWants", "ورش عمل": "miscWants", "كتب دراسية": "miscWants", "لوازم مدرسية": "miscWants", "أقساط": "miscWants", "رسوم دراسية": "miscWants", "مصاريف": "miscWants", "متنوعة": "miscWants", "أخرى": "miscWants", "عامة": "miscWants", "غير مصنفة": "miscWants", "غير محددة": "miscWants", "متفرقات": "miscWants", "أخرى": "miscWants", "عامة": "miscWants", "غير مصنفة": "miscWants", "غير محددة": "miscWants",
            "savings": "savings", "ادخار": "savings", "توفير": "توفير", "save": "savings"
        };


        // --- Utility Functions ---

        function showNotification(message, type) {
            const notificationArea = document.getElementById('notificationArea');
            const notificationMessage = document.getElementById('notificationMessage');
            
            // Clear previous classes
            notificationArea.className = 'p-4 mb-6 rounded-lg shadow-md text-center';

            notificationMessage.textContent = message;
            switch (type) {
                case 'warning':
                    notificationArea.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'danger':
                    notificationArea.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                    notificationArea.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'success':
                    notificationArea.classList.add('bg-green-100', 'text-green-800');
                    break;
            }
            notificationArea.classList.remove('hidden');
        }

        function clearNotification() {
            document.getElementById('notificationArea').classList.add('hidden');
            document.getElementById('notificationMessage').textContent = '';
        }

        function getOverallRemainingColor(remaining) {
            const totalIncomeAllocated = currentBudget.categories.filter(cat => cat.type !== 'Savings').reduce((sum, cat) => sum + cat.allocated, 0);
            if (remaining < 0) {
                return 'text-red-600';
            } else if (totalIncomeAllocated > 0 && remaining <= 0.2 * totalIncomeAllocated) {
                return 'text-yellow-600';
            }
            return 'text-green-600';
        }

        // --- UI Rendering Functions ---

        function renderSummary() {
            const totalAllocated = currentBudget.categories.reduce((sum, cat) => sum + cat.allocated, 0);
            const totalSpent = currentBudget.categories.reduce((sum, cat) => sum + cat.spent, 0);
            const overallRemaining = currentBudget.income - totalSpent;

            document.getElementById('incomeValue').textContent = currentBudget.income.toFixed(2);
            document.getElementById('totalAllocatedValue').textContent = totalAllocated.toFixed(2);
            document.getElementById('totalSpentValue').textContent = totalSpent.toFixed(2);
            
            const overallRemainingTextElement = document.getElementById('overallRemainingText');
            overallRemainingTextElement.className = `sm:col-span-3 text-2xl font-bold ${getOverallRemainingColor(overallRemaining)}`;
            document.getElementById('overallRemainingValue').textContent = overallRemaining.toFixed(2);
        }

        function renderCategories() {
            const categoryDetailsContainer = document.getElementById('categoryDetailsContainer');
            categoryDetailsContainer.innerHTML = ''; // Clear existing categories

            const types = ['Needs', 'Wants', 'Savings'];
            types.forEach(type => {
                const typeSection = document.createElement('div');
                typeSection.className = 'bg-gray-50 p-4 rounded-lg shadow-inner';
                typeSection.innerHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 mb-4">${type}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoryGrid-${type}">
                        <!-- Category cards will go here -->
                    </div>
                `;
                categoryDetailsContainer.appendChild(typeSection);

                const categoryGrid = typeSection.querySelector(`#categoryGrid-${type}`);
                currentBudget.categories.filter(cat => cat.type === type).forEach(category => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200 flex flex-col items-center text-center';
                    
                    const percentage = category.allocated > 0 ? Math.min(100, (category.spent / category.allocated) * 100) : 0;
                    const radius = (100 - 8) / 2; // size - strokeWidth
                    const circumference = radius * 2 * Math.PI;
                    const offset = circumference - (percentage / 100) * circumference;
                    let strokeColor = '#22C55E'; // green-500
                    if (percentage >= 100) {
                        strokeColor = '#EF4444'; // red-500
                    } else if (percentage >= 80) {
                        strokeColor = '#EAB308'; // yellow-500
                    }

                    categoryCard.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${category.name}</h3>
                        <div class="circular-progress-container" style="width: 100px; height: 100px;">
                            <svg class="transform -rotate-90" width="100" height="100">
                                <circle
                                    class="text-gray-300"
                                    stroke="currentColor"
                                    stroke-width="8"
                                    fill="transparent"
                                    r="${radius}"
                                    cx="50"
                                    cy="50"
                                />
                                <circle
                                    class="transition-all duration-500 ease-in-out"
                                    stroke="${strokeColor}"
                                    stroke-width="8"
                                    fill="transparent"
                                    r="${radius}"
                                    cx="50"
                                    cy="50"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${offset}"
                                    stroke-linecap="round"
                                />
                            </svg>
                            <div class="circular-progress-text-container">
                                <span class="circular-progress-percentage">${percentage.toFixed(0)}%</span>
                                <p class="circular-progress-spent-text">Spent</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm w-full">
                            <p class="text-gray-600">Allocated: ${category.allocated.toFixed(2)} EGP</p>
                            <p class="text-gray-600">Spent: ${category.spent.toFixed(2)} EGP</p>
                            <p class="font-medium mt-1 ${getOverallRemainingColor(category.allocated - category.spent)}">
                                Remaining: ${(category.allocated - category.spent).toFixed(2)} EGP
                            </p>
                            <div class="flex justify-center gap-2 mt-3">
                                <button data-id="${category.id}" class="edit-category-btn p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition duration-200" title="Edit Category">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                </button>
                                <button data-id="${category.id}" class="delete-category-btn p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition duration-200" title="Delete Category">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    categoryGrid.appendChild(categoryCard);
                });
            });

            // Populate category select dropdown for transaction modal
            const transactionCategoryDropdown = document.getElementById('modalTransactionCategory');
            transactionCategoryDropdown.innerHTML = '<option value="">Select Category</option>';
            currentBudget.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.type})`;
                transactionCategoryDropdown.appendChild(option);
            });
        }

        function renderTransactions() {
            const transactionListContainer = document.getElementById('transactionList');
            transactionListContainer.innerHTML = ''; // Clear existing transactions

            if (currentBudget.transactions.length === 0) {
                transactionListContainer.innerHTML = '<p class="text-gray-500" id="noTransactionsMessage">No transactions recorded yet.</p>';
                return;
            }

            // Sort transactions by date, newest first
            const sortedTransactions = [...currentBudget.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedTransactions.forEach(transaction => {
                const categoryName = currentBudget.categories.find(cat => cat.id === transaction.categoryId)?.name || 'Unknown Category';
                const transactionCard = document.createElement('div');
                transactionCard.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-center';
                transactionCard.innerHTML = `
                    <div class="flex-1 text-left mb-2 sm:mb-0">
                        <p class="text-lg font-semibold text-gray-800">${transaction.description || 'No description'}</p>
                        <p class="text-sm text-gray-600">Category: ${categoryName}</p>
                        <p class="text-sm text-gray-500">${new Date(transaction.date).toLocaleDateString()}</p>
                    </div>
                    <div class="flex-shrink-0 text-right sm:ml-4">
                        <p class="text-xl font-bold text-red-600 mb-2">${transaction.amount.toFixed(2)} EGP</p>
                        <div class="flex justify-end gap-2">
                            <button data-id="${transaction.id}" class="edit-transaction-btn p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition duration-200" title="Edit Transaction">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button data-id="${transaction.id}" class="delete-transaction-btn p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition duration-200" title="Delete Transaction">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                    </div>
                `;
                transactionListContainer.appendChild(transactionCard);
            });

            // Add event listeners for edit/delete transaction buttons
            document.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const transactionId = event.currentTarget.dataset.id;
                    const transactionToEdit = currentBudget.transactions.find(t => t.id === transactionId);
                    openTransactionModal(transactionToEdit);
                });
            });
            document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const transactionId = event.currentTarget.dataset.id;
                    handleDeleteTransaction(transactionId);
                });
            });
        }

        function updateUI() {
            renderSummary();
            renderCategories();
            renderTransactions(); // New: Render transaction history
            // Update UI element states based on global variables
            const processReceiptButton = document.getElementById('processReceiptButton');
            const receiptAuthWarning = document.getElementById('receiptAuthWarning');
            const userIdDisplay = document.getElementById('userIdDisplay');
            const userIdValue = document.getElementById('userIdValue');

            if (currentUserId) {
                userIdDisplay.classList.remove('hidden');
                userIdValue.textContent = currentUserId;
            } else {
                userIdDisplay.classList.add('hidden');
            }

            // Tesseract.js does not need API key or auth check for its core function
            processReceiptButton.disabled = isProcessingReceipt || !currentUserId; // Still check auth for saving to Firestore
            processReceiptButton.classList.toggle('bg-gray-400', processReceiptButton.disabled);
            processReceiptButton.classList.toggle('text-gray-700', processReceiptButton.disabled);
            processReceiptButton.classList.toggle('cursor-not-allowed', processReceiptButton.disabled);
            processReceiptButton.classList.toggle('bg-green-600', !processReceiptButton.disabled);
            processReceiptButton.classList.toggle('text-white', !processReceiptButton.disabled);
            processReceiptButton.classList.toggle('hover:bg-green-700', !processReceiptButton.disabled);

            document.getElementById('processingReceiptMessage').classList.toggle('hidden', !isProcessingReceipt);

            receiptAuthWarning.classList.toggle('hidden', currentUserId !== null);
        }


        // --- Firebase Interaction Functions ---

        async function updateBudgetInFirestore() {
            if (!currentUserId) {
                showNotification('User not authenticated. Data not saved.', 'warning');
                return;
            }
            const userBudgetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUserId}/budget/current`);
            try {
                await setDoc(userBudgetDocRef, currentBudget);
                // Notification handled by snapshot listener
            } catch (error) {
                console.error("Error saving budget to Firestore:", error);
                showNotification(`Error saving data: ${error.message}`, 'danger');
            }
        }

        // --- Core Logic Functions ---

        // Recalculates spent amount for all categories based on current transactions
        function recalculateCategorySpent() {
            // Reset all spent amounts to zero
            currentBudget.categories.forEach(cat => cat.spent = 0);

            // Sum up spent amounts from transactions
            currentBudget.transactions.forEach(transaction => {
                const category = currentBudget.categories.find(cat => cat.id === transaction.categoryId);
                if (category) {
                    category.spent += transaction.amount;
                }
            });
        }

        function addTransaction(categoryId, amount, description, date) {
            const newTransaction = {
                id: Date.now().toString(), // Simple unique ID
                categoryId: categoryId,
                amount: parseFloat(amount),
                description: description || '',
                date: date || new Date().toISOString().split('T')[0] // YYYY-MM-DD
            };
            currentBudget.transactions.push(newTransaction);
            recalculateCategorySpent();
            updateBudgetInFirestore();
            showNotification('Expense added successfully!', 'success');
        }

        function editTransaction(transactionId, newCategoryId, newAmount, newDescription, newDate) {
            const transactionIndex = currentBudget.transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex !== -1) {
                currentBudget.transactions[transactionIndex] = {
                    id: transactionId,
                    categoryId: newCategoryId,
                    amount: parseFloat(newAmount),
                    description: newDescription || '',
                    date: newDate || new Date().toISOString().split('T')[0]
                };
                recalculateCategorySpent();
                updateBudgetInFirestore();
                showNotification('Expense updated successfully!', 'success');
            } else {
                showNotification('Transaction not found.', 'warning');
            }
        }

        function handleDeleteTransaction(transactionId) {
            if (!currentUserId) {
                showNotification('User not authenticated. Cannot delete transaction.', 'warning');
                return;
            }

            const confirmModal = document.createElement('div');
            confirmModal.className = 'custom-modal-overlay';
            confirmModal.innerHTML = `
                <div class="custom-modal-content">
                    <h2 class="custom-modal-title">Confirm Deletion</h2>
                    <p class="text-gray-700 mb-6">Are you sure you want to delete this transaction? This action cannot be undone.</p>
                    <div class="custom-modal-buttons">
                        <button id="confirmDeleteTransactionBtn" class="custom-modal-button custom-modal-confirm">Delete</button>
                        <button id="cancelDeleteTransactionBtn" class="custom-modal-button custom-modal-cancel">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            document.getElementById('confirmDeleteTransactionBtn').addEventListener('click', () => {
                currentBudget.transactions = currentBudget.transactions.filter(t => t.id !== transactionId);
                recalculateCategorySpent();
                updateBudgetInFirestore();
                showNotification('Transaction deleted successfully!', 'success');
                confirmModal.remove();
            });

            document.getElementById('cancelDeleteTransactionBtn').addEventListener('click', () => {
                confirmModal.remove();
            });
        }


        async function processReceipt(file) {
            if (!file) {
                showNotification('Please upload a receipt image first.', 'warning');
                return;
            }
            if (!currentUserId) { // Only check auth for saving data, Tesseract itself is client-side
                showNotification('User not authenticated. Cannot process receipt and save data.', 'warning');
                return;
            }

            isProcessingReceipt = true;
            updateUI(); // Update button state
            showNotification('Processing receipt with Tesseract.js...', 'info');

            try {
                // Use Tesseract.js to recognize text from the image
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'eng+ara', // Language code: English and Arabic
                    { logger: m => console.log(m) } // Optional: log progress to console
                );

                console.log("Tesseract.js Raw Text Output:", text);

                // --- Basic Client-Side Parsing Logic ---
                let extractedAmount = 0;
                let extractedCategory = "miscWants"; // Default if unable to parse
                let extractedDescription = "Receipt Scan"; // Default description

                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                const lowerCaseText = text.toLowerCase();

                // Regex to find potential currency amounts (e.g., 123.45, 123)
                // Handles both dot and Arabic comma (٫) as decimal separators, and optional thousand separators
                const amountRegex = /(\d{1,3}(?:[.,]\d{3})*(?:[.,٫]\d{1,2})?|\d+[.,٫]\d{1,2})/; 

                let potentialTotals = [];

                // First pass: Look for "Total" keywords and extract associated numbers
                for (const line of lines) {
                    const lowerCaseLine = line.toLowerCase();
                    const totalKeywords = ["total", "total amount", "amount due", "net total", "الإجمالي", "المبلغ الكلي", "مجموع", "sum", "grand total", "payable", "اجمالي", "صافي", "total price", "total cost", "final amount", "final total", "إجمالي الفاتورة", "المبلغ المستحق", "القيمة الإجمالية"];
                    for (const keyword of totalKeywords) {
                        if (lowerCaseLine.includes(keyword)) {
                            // Try to find amount directly after keyword or on the same line
                            const match = lowerCaseLine.match(new RegExp(`${keyword}\\s*[:]?\\s*([\\d.,٫]+)`));
                            if (match && match[1]) {
                                let potentialAmount = parseFloat(match[1].replace(/,/g, '').replace('٫', '.'));
                                if (!isNaN(potentialAmount) && potentialAmount > 0) {
                                    potentialTotals.push(potentialAmount);
                                }
                            }
                            // Also try to find a number on the same line if keyword is present
                            const lineAmounts = line.match(new RegExp(amountRegex.source, 'g'));
                            if (lineAmounts && lineAmounts.length > 0) {
                                lineAmounts.forEach(amtStr => {
                                    const num = parseFloat(amtStr.replace(/,/g, '').replace('٫', '.'));
                                    if (!isNaN(num) && num > 0) {
                                        potentialTotals.push(num);
                                    }
                                });
                            }
                        }
                    }
                }

                // If multiple potential totals, try to pick the largest one
                if (potentialTotals.length > 0) {
                    extractedAmount = Math.max(...potentialTotals);
                } else {
                    // Fallback: if no clear "Total" found, try to find the largest number on the entire receipt
                    let maxAmountOverall = 0;
                    const allAmounts = text.match(new RegExp(amountRegex.source, 'g'));
                    if (allAmounts) {
                        allAmounts.forEach(amtStr => {
                            const num = parseFloat(amtStr.replace(/,/g, '').replace('٫', '.'));
                            if (!isNaN(num) && num > maxAmountOverall) {
                                maxAmountOverall = num;
                            }
                        });
                    }
                    extractedAmount = maxAmountOverall;
                }

                // Simple keyword matching for categories
                // Expanded keywords for better accuracy
                const keywords = {
                    "groceries": ["groceries", "بقالة", "مشتريات", "سوبر ماركت", "supermarket", "food", "اكل", "طعام", "carrefour", "spinneys", "metro market", "أسواق", "خضروات", "فواكه", "بضائع", "لحوم", "دواجن", "ألبان", "خبز", "بقالة", "اولاد الحاج رجب", "أولاد الحاج رجب", "هايب", "hyper one", "هايبر وان"],
                    "utilities": ["utilities", "فواتير", "كهرباء", "مياه", "غاز", "انترنت", "bills", "electricity", "water", "gas", "internet", "فاتورة", "اتصالات"],
                    "homeOwnership": ["home ownership", "صيانة منزل", "رسوم مبنى", "نظافة شقة", "home maintenance", "rent", "housing", "ايجار", "صيانة", "منزل", "عقارات"],
                    "fuel": ["fuel", "وقود", "بنزين", "gas", "petrol", "car", "سيارة", "محروقات", "بنزينه"],
                    "healthcare": ["healthcare", "صحة", "عناية شخصية", "صيدلية", "pharmacy", "doctor", "health", "personal care", "دكتور", "علاج", "ادوية"],
                    "dogEssentials": ["dog essentials", "مستلزمات كلب", "طعام كلاب", "بيطري", "pet food", "vet", "dog food", "حيوانات", "كلاب", "قطط"],
                    "cigarettes": ["cigarettes", "سجائر", "دخان", "smoking", "دخان"],
                    "gifts": ["gifts", "هدايا", "مناسبات اجتماعية", "presents", "social", "هدية"],
                    "sweetTooth": ["sweet tooth", "حلويات", "سكريات", "dessert", "sweets", "chocolate", "شوكولاتة", "كيك", "جاتوه"],
                    "subscriptions": ["subscriptions", "اشتراكات", "نتفليكس", "نتفلكس", "جوجل ون", "سبوتيفاي", "netflix", "spotify", "google one", "apps", "تطبيقات", "اشتراك"],
                    "diningOut": ["take out", "dining out", "مطاعم", "وجبات سريعة", "خارج المنزل", "restaurant", "food delivery", "eating out", "مطعم", "وجبات", "كافيه", "قهوة", "مقهى"],
                    "miscWants": ["miscellaneous wants", "متفرقات", "تسوق", "ترفيه", "أخرى", "shopping", "entertainment", "other", "شراء", "ترفيه", "ملابس", "احذية", "الكترونيات", "decathlon", "ديكاتلون", "رياضة", "sports", "hyper one", "هايبر وان", "butcher", "جزار", "مخبز", "مكتبة", "ألعاب", "هوايات", "أدوات", "منزلية", "مفروشات", "أجهزة", "كهربائية", "ديكور", "أثاث", "مستحضرات تجميل", "عطور", "إكسسوارات", "مجوهات", "ساعات", "حقائب", "أمتعة", "كتب", "مجلات", "جرائد", "قرطاسية", "لوازم مكتبية", "أدوات مدرسية", "أدوات فنية", "آلات موسيقية", "أدوات رياضية", "معدات رياضية", "أدوات تخييم", "أدوات صيد", "أدوات غطس", "أدوات سباحة", "أدوات لياقة", "أدوات بناء", "أدوات حدائق", "أدوات سيارات", "قطع غيار", "إطارات", "بطاريات", "زيوت", "فلاتر", "إصلاحات", "صيانة", "خدمات", "تأمين", "رسوم", "ضرائب", "غرامات", "تبرعات", "مساعدات", "تعليم", "دورات", "ورش عمل", "كتب دراسية", "لوازم مدرسية", "أقساط", "رسوم دراسية", "مصاريف", "متنوعة", "أخرى", "عامة", "غير مصنفة", "غير محددة", "متفرقات", "أخرى", "عامة", "غير مصنفة", "غير محددة"],
                    "savings": "savings", "ادخار": "savings", "توفير": "توفير", "save": "savings"
                };

                let foundCategory = false;
                for (const categoryId in keywords) {
                    const categoryKeywords = keywords[categoryId];
                    for (const keyword of categoryKeywords) {
                        if (lowerCaseText.includes(keyword.toLowerCase())) {
                            extractedCategory = categoryId;
                            foundCategory = true;
                            break; // Found a match, take the first one
                        }
                    }
                    if (foundCategory) {
                        break; // Found a category, stop searching
                    }
                }

                // Try to extract a description from the first few lines or common store names
                const storeNames = ["decathlon", "ديكاتلون", "carrefour", "spinneys", "metro market", "صيدلية", "pharmacy", "restaurant", "مطعم", "اولاد الحاج رجب", "أولاد الحاج رجب", "hyper one", "هايبر وان", "butcher", "جزار"];
                for (const storeName of storeNames) {
                    if (lowerCaseText.includes(storeName)) {
                        extractedDescription = `Purchase at ${storeName.charAt(0).toUpperCase() + storeName.slice(1)}`;
                        break;
                    }
                }
                if (extractedDescription === "Receipt Scan" && lines.length > 0) {
                    // Take the first non-empty line as a potential description if no store name found
                    extractedDescription = lines[0].substring(0, 50); // Limit description length
                }
                
                // Apply the extracted data
                if (!isNaN(extractedAmount) && extractedAmount > 0) {
                    addTransaction(extractedCategory, extractedAmount, extractedDescription, new Date().toISOString().split('T')[0]);
                    showNotification(`Receipt processed (Tesseract.js)! Added ${extractedAmount.toFixed(2)} EGP to ${currentBudget.categories.find(cat => cat.id === extractedCategory)?.name}.`, 'success');
                } else {
                    showNotification(`Could not accurately parse receipt (Tesseract.js). Please add manually. Raw Text: "${text.substring(0, Math.min(text.length, 200))}..."`, 'warning'); // Show more raw text for debugging
                }

            } catch (error) {
                console.error("Error processing receipt with Tesseract.js:", error);
                showNotification(`Error processing receipt with Tesseract.js: ${error.message}. Please try again.`, 'danger');
            } finally {
                isProcessingReceipt = false;
                document.getElementById('receiptImageInput').value = ''; // Clear file input
                updateUI(); // Update button state
            }
        }

        // --- Category Management Functions ---

        function handleSaveCategory(newCategoryData) {
            if (!currentUserId) {
                showNotification('User not authenticated. Cannot save category.', 'warning');
                return;
            }

            let updatedCategories;
            if (editingCategory) {
                // Edit existing category
                updatedCategories = currentBudget.categories.map(cat =>
                    cat.id === newCategoryData.id ? newCategoryData : cat
                );
            } else {
                // Add new category
                updatedCategories = [...currentBudget.categories, newCategoryData];
            }
            currentBudget = { ...currentBudget, categories: updatedCategories };
            recalculateCategorySpent(); // Recalculate if category allocations change
            updateBudgetInFirestore();
            showNotification('Category saved successfully!', 'success');
            closeCategoryModal();
        }

        function handleDeleteCategory(categoryId) {
            if (!currentUserId) {
                showNotification('User not authenticated. Cannot delete category.', 'warning');
                return;
            }

            const confirmModal = document.createElement('div');
            confirmModal.className = 'custom-modal-overlay';
            confirmModal.innerHTML = `
                <div class="custom-modal-content">
                    <h2 class="custom-modal-title">Confirm Deletion</h2>
                    <p class="text-gray-700 mb-6">Are you sure you want to delete this category? All associated transactions will remain but will show as 'Unknown Category'.</p>
                    <div class="custom-modal-buttons">
                        <button id="confirmDeleteCategoryBtn" class="custom-modal-button custom-modal-confirm">Delete</button>
                        <button id="cancelDeleteCategoryBtn" class="custom-modal-button custom-modal-cancel">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            document.getElementById('confirmDeleteCategoryBtn').addEventListener('click', () => {
                currentBudget.categories = currentBudget.categories.filter(cat => cat.id !== categoryId);
                // Transactions linked to this category will now point to a non-existent ID,
                // which will be handled by 'Unknown Category' in renderTransactions.
                recalculateCategorySpent(); // Recalculate after category deletion
                updateBudgetInFirestore();
                showNotification('Category deleted successfully!', 'success');
                confirmModal.remove();
            });

            document.getElementById('cancelDeleteCategoryBtn').addEventListener('click', () => {
                confirmModal.remove();
            });
        }

        function openCategoryModal(category = null) {
            editingCategory = category;
            const modalOverlay = document.getElementById('categoryModalOverlay');
            const modalTitle = document.getElementById('categoryModalTitle');
            const modalCategoryName = document.getElementById('modalCategoryName');
            const modalAllocatedAmount = document.getElementById('modalAllocatedAmount');
            const modalCategoryType = document.getElementById('modalCategoryType');
            const formSubmitButton = modalOverlay.querySelector('button[type="submit"]');

            if (category) {
                modalTitle.textContent = 'Edit Category';
                modalCategoryName.value = category.name;
                modalAllocatedAmount.value = category.allocated;
                modalCategoryType.value = category.type;
                formSubmitButton.textContent = 'Save Changes';
            } else {
                modalTitle.textContent = 'Add New Category';
                modalCategoryName.value = '';
                modalAllocatedAmount.value = '';
                modalCategoryType.value = 'Needs';
                formSubmitButton.textContent = 'Add Category';
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModalOverlay').classList.add('hidden');
            editingCategory = null;
        }

        // --- Transaction Modal Functions ---
        function openTransactionModal(transaction = null) {
            editingTransaction = transaction;
            const modalOverlay = document.getElementById('transactionModalOverlay');
            const modalTitle = document.getElementById('transactionModalTitle');
            const modalAmount = document.getElementById('modalTransactionAmount');
            const modalCategory = document.getElementById('modalTransactionCategory');
            const modalDescription = document.getElementById('modalTransactionDescription');
            const modalDate = document.getElementById('modalTransactionDate');
            const formSubmitButton = document.getElementById('submitTransactionButton');

            // Set today's date as default for new transactions
            const today = new Date().toISOString().split('T')[0];

            if (transaction) {
                modalTitle.textContent = 'Edit Expense';
                modalAmount.value = transaction.amount;
                modalCategory.value = transaction.categoryId;
                modalDescription.value = transaction.description;
                modalDate.value = transaction.date;
                formSubmitButton.textContent = 'Save Changes';
            } else {
                modalTitle.textContent = 'Add New Expense';
                modalAmount.value = '';
                modalCategory.value = '';
                modalDescription.value = '';
                modalDate.value = today; // Default to today
                formSubmitButton.textContent = 'Add Expense';
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModalOverlay').classList.add('hidden');
            editingTransaction = null;
        }


        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial UI update for loading state
            updateUI(); 

            // Firebase Auth Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isAuthReady = true;
                    showNotification('Authenticated successfully!', 'success');
                    // Start Firestore listener after auth is ready
                    const userBudgetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUserId}/budget/current`);
                    onSnapshot(userBudgetDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentBudget = docSnap.data();
                            // Ensure transactions array exists
                            if (!currentBudget.transactions) {
                                currentBudget.transactions = [];
                            }
                            recalculateCategorySpent(); // Always recalculate on data load
                            showNotification('Budget loaded from cloud!', 'success');
                        } else {
                            // If no budget exists, create a default one
                            setDoc(userBudgetDocRef, currentBudget)
                                .then(() => showNotification('Default budget created in cloud!', 'success'))
                                .catch(error => showNotification(`Error creating default budget: ${error.message}`, 'danger'));
                        }
                        updateUI(); // Update UI after data load/change
                    }, (error) => {
                        console.error("Error fetching budget:", error);
                        showNotification(`Error syncing budget: ${error.message}`, 'danger');
                    });
                } else {
                    currentUserId = null;
                    isAuthReady = true; // Still ready, but user is not logged in
                    showNotification('Not authenticated. Data will not be saved persistently.', 'warning');
                    updateUI(); // Update UI even if not authenticated
                }
            });

            // Initial anonymous sign-in
            signInAnonymously(auth).catch(error => {
                console.error("Firebase Anonymous Auth error:", error);
                showNotification(`Authentication failed: ${error.message}`, 'danger');
            });


            // Event Listeners
            document.getElementById('dismissNotification').addEventListener('click', clearNotification);
            
            // Open Add Transaction Modal
            document.getElementById('openAddTransactionModalButton').addEventListener('click', () => openTransactionModal());

            // Handle Transaction Form Submission
            document.getElementById('transactionForm').addEventListener('submit', (event) => {
                event.preventDefault();
                const amount = parseFloat(document.getElementById('modalTransactionAmount').value);
                const categoryId = document.getElementById('modalTransactionCategory').value;
                const description = document.getElementById('modalTransactionDescription').value;
                const date = document.getElementById('modalTransactionDate').value;

                if (!categoryId || isNaN(amount) || amount <= 0 || !date) {
                    showNotification('Please fill all transaction fields correctly (Amount, Category, Date).', 'warning');
                    return;
                }

                if (editingTransaction) {
                    editTransaction(editingTransaction.id, categoryId, amount, description, date);
                } else {
                    addTransaction(categoryId, amount, description, date);
                }
                closeTransactionModal();
            });
            document.getElementById('cancelTransactionModal').addEventListener('click', closeTransactionModal);


            document.getElementById('receiptImageInput').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    processReceipt(file);
                } else {
                    showNotification('No file selected.', 'warning');
                }
            });

            document.getElementById('processReceiptButton').addEventListener('click', () => {
                const fileInput = document.getElementById('receiptImageInput');
                if (fileInput.files.length > 0) {
                    processReceipt(fileInput.files[0]);
                } else {
                    showNotification('Please select an image first using the "Choose File" button.', 'warning');
                }
            });

            // Category Management Listeners
            document.getElementById('addCategoryModalButton').addEventListener('click', () => openCategoryModal());
            document.getElementById('cancelCategoryModal').addEventListener('click', closeCategoryModal);
            document.getElementById('categoryForm').addEventListener('submit', (event) => {
                event.preventDefault();
                const name = document.getElementById('modalCategoryName').value;
                const allocated = parseFloat(document.getElementById('modalAllocatedAmount').value);
                const type = document.getElementById('modalCategoryType').value;

                if (name && !isNaN(allocated) && allocated >= 0) {
                    const newCategoryData = {
                        id: editingCategory ? editingCategory.id : Date.now().toString(),
                        name: name,
                        allocated: allocated,
                        spent: editingCategory ? editingCategory.spent : 0,
                        type: type
                    };
                    handleSaveCategory(newCategoryData);
                } else {
                    showNotification('Please fill all category fields correctly.', 'warning');
                }
            });
        });
    </script>
</body>
</html>
